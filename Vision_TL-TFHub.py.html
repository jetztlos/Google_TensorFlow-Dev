<html>
<head>
<title>Vision_TL-TFHub.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #8c8c8c; font-style: italic;}
.s1 { color: #080808;}
.s2 { color: #0033b3;}
.s3 { color: #067d17;}
.s4 { color: #1750eb;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Vision_TL-TFHub.py</font>
</center></td></tr></table>
<pre><span class="s0"># From: https://www.tensorflow.org/tutorials/images/transfer_learning_with_hub</span>
<span class="s0">## Setup</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">time</span>

<span class="s2">import </span><span class="s1">PIL.Image </span><span class="s2">as </span><span class="s1">Image</span>
<span class="s2">import </span><span class="s1">matplotlib.pylab </span><span class="s2">as </span><span class="s1">plt</span>

<span class="s2">import </span><span class="s1">tensorflow </span><span class="s2">as </span><span class="s1">tf</span>
<span class="s2">import </span><span class="s1">tensorflow_hub </span><span class="s2">as </span><span class="s1">hub</span>

<span class="s2">import </span><span class="s1">datetime</span>

<span class="s0"># %load_ext tensorboard</span>

<span class="s0">## An ImageNet classifier</span>
<span class="s0">### Download the classifier</span>
<span class="s1">mobilenet_v2 = </span><span class="s3">&quot;https://tfhub.dev/google/tf2-preview/mobilenet_v2/classification/4&quot;</span>
<span class="s1">inception_v3 = </span><span class="s3">&quot;https://tfhub.dev/google/imagenet/inception_v3/classification/5&quot;</span>

<span class="s1">classifier_model = mobilenet_v2</span>

<span class="s1">IMAGE_SHAPE = (</span><span class="s4">224</span><span class="s1">, </span><span class="s4">224</span><span class="s1">)</span>

<span class="s1">classifier = tf.keras.Sequential([</span>
    <span class="s1">hub.KerasLayer(classifier_model, input_shape=IMAGE_SHAPE+(</span><span class="s4">3</span><span class="s1">,))</span>
<span class="s1">])</span>

<span class="s0">### Run it on a single image</span>
<span class="s1">grace_hopper = tf.keras.utils.get_file(</span><span class="s3">'image.jpg'</span><span class="s1">, </span><span class="s3">'https://storage.googleapis.com/download.tensorflow.org/example_images/grace_hopper.jpg'</span><span class="s1">)</span>
<span class="s1">grace_hopper = Image.open(grace_hopper).resize(IMAGE_SHAPE)</span>
<span class="s1">grace_hopper</span>

<span class="s1">grace_hopper = np.array(grace_hopper)/</span><span class="s4">255.</span>
<span class="s1">grace_hopper.shape</span>

<span class="s1">result = classifier.predict(grace_hopper[np.newaxis, ...])</span>
<span class="s1">result.shape</span>

<span class="s1">predicted_class = tf.math.argmax(result[</span><span class="s4">0</span><span class="s1">], axis=-</span><span class="s4">1</span><span class="s1">)</span>
<span class="s1">predicted_class</span>

<span class="s0">### Decode the predictions</span>
<span class="s1">labels_path = tf.keras.utils.get_file(</span><span class="s3">'ImageNetLabels.txt'</span><span class="s1">, </span><span class="s3">'https://storage.googleapis.com/download.tensorflow.org/data/ImageNetLabels.txt'</span><span class="s1">)</span>
<span class="s1">imagenet_labels = np.array(open(labels_path).read().splitlines())</span>

<span class="s1">plt.imshow(grace_hopper)</span>
<span class="s1">plt.axis(</span><span class="s3">'off'</span><span class="s1">)</span>
<span class="s1">predicted_class_name = imagenet_labels[predicted_class]</span>
<span class="s1">_ = plt.title(</span><span class="s3">&quot;Prediction:&quot; </span><span class="s1">+ predicted_class_name.title())</span>

<span class="s0">## Simple transfer learning</span>
<span class="s0">### Dataset</span>
<span class="s2">import </span><span class="s1">pathlib</span>

<span class="s1">data_file = tf.keras.utils.get_file(</span>
    <span class="s3">'flower_photos.tgz'</span><span class="s1">,</span>
    <span class="s3">'https://storage.googleapis.com/download.tensorflow.org/example_images/flower_photos.tgz'</span><span class="s1">,</span>
    <span class="s1">cache_dir=</span><span class="s3">'.'</span><span class="s1">, extract=</span><span class="s2">True</span>
<span class="s1">)</span>

<span class="s1">data_root = pathlib.Path(data_file).with_suffix(</span><span class="s3">''</span><span class="s1">)</span>

<span class="s1">batch_size = </span><span class="s4">32</span>
<span class="s1">img_height = </span><span class="s4">224</span>
<span class="s1">img_width = </span><span class="s4">224</span>

<span class="s1">train_ds = tf.keras.utils.image_dataset_from_directory(str(data_root),</span>
                                                       <span class="s1">validation_split=</span><span class="s4">0.2</span><span class="s1">,</span>
                                                       <span class="s1">subset=</span><span class="s3">&quot;training&quot;</span><span class="s1">,</span>
                                                       <span class="s1">seed=</span><span class="s4">123</span><span class="s1">,</span>
                                                       <span class="s1">image_size=(img_height, img_width),</span>
                                                       <span class="s1">batch_size=batch_size)</span>

<span class="s1">val_ds = tf.keras.utils.image_dataset_from_directory(str(data_root),</span>
                                                     <span class="s1">validation_split=</span><span class="s4">0.2</span><span class="s1">,</span>
                                                     <span class="s1">subset=</span><span class="s3">&quot;validation&quot;</span><span class="s1">,</span>
                                                     <span class="s1">seed=</span><span class="s4">123</span><span class="s1">,</span>
                                                     <span class="s1">image_size=(img_height, img_width),</span>
                                                     <span class="s1">batch_size=batch_size)</span>

<span class="s1">class_names = np.array(train_ds.class_names)</span>
<span class="s1">print(class_names)</span>

<span class="s1">normalization_layer = tf.keras.layers.Rescaling(</span><span class="s4">1</span><span class="s1">/</span><span class="s4">255.</span><span class="s1">)</span>
<span class="s1">train_ds = train_ds.map(</span><span class="s2">lambda </span><span class="s1">x, y: (normalization_layer(x), y)) </span><span class="s0"># Where x-images, y-labels.</span>
<span class="s1">val_ds = val_ds.map(</span><span class="s2">lambda </span><span class="s1">x, y: (normalization_layer(x), y)) </span><span class="s0"># Where x-images, y-labels.</span>

<span class="s1">AUTOTUNE = tf.data.AUTOTUNE</span>
<span class="s1">train_ds = train_ds.cache().prefetch(buffer_size=AUTOTUNE)</span>
<span class="s1">val_ds = val_ds.cache().prefetch(buffer_size=AUTOTUNE)</span>

<span class="s2">for </span><span class="s1">image_batch, labels_batch </span><span class="s2">in </span><span class="s1">train_ds:</span>
    <span class="s1">print(image_batch.shape)</span>
    <span class="s1">print(labels_batch.shape)</span>
    <span class="s2">break</span>

<span class="s0">### Run the classifier on a batch of images</span>
<span class="s1">result_batch = classifier.predict(train_ds)</span>

<span class="s1">predicted_class_names = imagenet_labels[tf.math.argmax(result_batch, axis=-</span><span class="s4">1</span><span class="s1">)]</span>
<span class="s1">predicted_class_names</span>

<span class="s1">plt.figure(figsize=(</span><span class="s4">10</span><span class="s1">, </span><span class="s4">9</span><span class="s1">))</span>
<span class="s1">plt.subplots_adjust(hspace=</span><span class="s4">0.5</span><span class="s1">)</span>
<span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range(</span><span class="s4">30</span><span class="s1">):</span>
    <span class="s1">plt.subplot(</span><span class="s4">6</span><span class="s1">, </span><span class="s4">5</span><span class="s1">, n+</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">plt.imshow(image_batch[n])</span>
    <span class="s1">plt.title(predicted_class_names[n])</span>
    <span class="s1">plt.axis(</span><span class="s3">'off'</span><span class="s1">)</span>
<span class="s1">_ = plt.suptitle(</span><span class="s3">&quot;ImageNet predictions&quot;</span><span class="s1">)</span>

<span class="s0">### Download the headless model</span>
<span class="s1">mobilenet_v2 = </span><span class="s3">&quot;https://tfhub.dev/google/tf2-preview/mobilenet_v2/feature_vector/4&quot;</span>
<span class="s1">inception_v3 = </span><span class="s3">&quot;https://tfhub.dev/google/tf2-preview/inception_v3/feature_vector/4&quot;</span>

<span class="s1">feature_extractor_model = mobilenet_v2</span>

<span class="s1">feature_extractor_layer = hub.KerasLayer(feature_extractor_model,</span>
                                         <span class="s1">input_shape=(</span><span class="s4">224</span><span class="s1">, </span><span class="s4">224</span><span class="s1">, </span><span class="s4">3</span><span class="s1">),</span>
                                         <span class="s1">trainable=</span><span class="s2">False</span><span class="s1">)</span>

<span class="s1">feature_batch = feature_extractor_layer(image_batch)</span>
<span class="s1">print(feature_batch.shape)</span>

<span class="s0">### Attach a classification head</span>
<span class="s1">num_classes = len(class_names)</span>

<span class="s1">model = tf.keras.Sequential([</span>
    <span class="s1">feature_extractor_layer,</span>
    <span class="s1">tf.keras.layers.Dense(num_classes)</span>
<span class="s1">])</span>

<span class="s1">model.summary()</span>

<span class="s1">predictions = model(image_batch)</span>

<span class="s1">predictions.shape</span>

<span class="s0">### Train the model</span>
<span class="s1">model.compile(loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=</span><span class="s2">True</span><span class="s1">),</span>
              <span class="s1">optimizer=tf.keras.optimizers.Adam(),</span>
              <span class="s1">metrics=[</span><span class="s3">'acc'</span><span class="s1">])</span>

<span class="s1">log_dir = </span><span class="s3">&quot;logs/fit/&quot; </span><span class="s1">+ datetime.datetime.now().strftime(</span><span class="s3">&quot;%Y%m%d-%H%M%S&quot;</span><span class="s1">)</span>
<span class="s1">tensorboard_callback = tf.keras.callbacks.TensorBoard(</span>
    <span class="s1">log_dir=log_dir,</span>
    <span class="s1">histogram_freq=</span><span class="s4">1 </span><span class="s0"># Enable histogram computation for every epoch.</span>
<span class="s1">)</span>

<span class="s1">NUM_EPOCHS = </span><span class="s4">10</span>

<span class="s1">history = model.fit(train_ds,</span>
                    <span class="s1">epochs=NUM_EPOCHS,</span>
                    <span class="s1">validation_data=val_ds,</span>
                    <span class="s1">callbacks=tensorboard_callback)</span>

<span class="s0"># %tensorboard --logdir logs/fit</span>

<span class="s0">### Check the predictions</span>
<span class="s1">predicted_batch = model.predict(image_batch)</span>
<span class="s1">predicted_id = tf.math.argmax(predicted_batch, axis=-</span><span class="s4">1</span><span class="s1">)</span>
<span class="s1">predicted_label_batch = class_names[predicted_id]</span>
<span class="s1">print(predicted_label_batch)</span>

<span class="s1">plt.figure(figsize=(</span><span class="s4">10</span><span class="s1">,</span><span class="s4">9</span><span class="s1">))</span>
<span class="s1">plt.subplots_adjust(hspace=</span><span class="s4">0.5</span><span class="s1">)</span>

<span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range(</span><span class="s4">30</span><span class="s1">):</span>
  <span class="s1">plt.subplot(</span><span class="s4">6</span><span class="s1">,</span><span class="s4">5</span><span class="s1">,n+</span><span class="s4">1</span><span class="s1">)</span>
  <span class="s1">plt.imshow(image_batch[n])</span>
  <span class="s1">plt.title(predicted_label_batch[n].title())</span>
  <span class="s1">plt.axis(</span><span class="s3">'off'</span><span class="s1">)</span>
<span class="s1">_ = plt.suptitle(</span><span class="s3">&quot;Model predictions&quot;</span><span class="s1">)</span>

<span class="s0">## Export and reload your model</span>
<span class="s1">t = time.time()</span>

<span class="s1">export_path = </span><span class="s3">&quot;/tmp/saved_models/{}&quot;</span><span class="s1">.format(int(t))</span>
<span class="s1">model.save(export_path)</span>

<span class="s1">export_path</span>

<span class="s1">reloaded = tf.keras.models.load_model(export_path)</span>

<span class="s1">result_batch = model.predict(image_batch)</span>
<span class="s1">reloaded_result_batch = reloaded.predict(image_batch)</span>

<span class="s1">abs(reloaded_result_batch - result_batch).max()</span>

<span class="s1">reloaded_predicted_id = tf.math.argmax(reloaded_result_batch, axis=-</span><span class="s4">1</span><span class="s1">)</span>
<span class="s1">reloaded_predicted_label_batch = class_names[reloaded_predicted_id]</span>
<span class="s1">print(reloaded_predicted_label_batch)</span>

<span class="s1">plt.figure(figsize=(</span><span class="s4">10</span><span class="s1">,</span><span class="s4">9</span><span class="s1">))</span>
<span class="s1">plt.subplots_adjust(hspace=</span><span class="s4">0.5</span><span class="s1">)</span>
<span class="s2">for </span><span class="s1">n </span><span class="s2">in </span><span class="s1">range(</span><span class="s4">30</span><span class="s1">):</span>
  <span class="s1">plt.subplot(</span><span class="s4">6</span><span class="s1">,</span><span class="s4">5</span><span class="s1">,n+</span><span class="s4">1</span><span class="s1">)</span>
  <span class="s1">plt.imshow(image_batch[n])</span>
  <span class="s1">plt.title(reloaded_predicted_label_batch[n].title())</span>
  <span class="s1">plt.axis(</span><span class="s3">'off'</span><span class="s1">)</span>
<span class="s1">_ = plt.suptitle(</span><span class="s3">&quot;Model predictions&quot;</span><span class="s1">)</span>





</pre>
</body>
</html>